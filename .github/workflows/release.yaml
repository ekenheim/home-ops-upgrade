---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release

on:
  push:
    tags:
      - "*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: Existing tag to release (for backfill/retry)
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Determine tag
        id: tag
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "value=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Verify tag exists (manual runs)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        shell: bash
        run: |
          git ls-remote --exit-code --tags \
            "https://github.com/${{ github.repository }}.git" \
            "refs/tags/${{ steps.tag.outputs.value }}"

      - name: Create release if missing
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          tag="${{ steps.tag.outputs.value }}"

          if gh release view "$tag" --repo "${{ github.repository }}" >/dev/null 2>&1; then
            echo "Release for tag $tag already exists. Skipping."
            exit 0
          fi

          gh release create "$tag" \
            --repo "${{ github.repository }}" \
            --title "$tag" \
            --generate-notes
