---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
# https://artifacthub.io/packages/helm/dagster/dagster
# https://github.com/dagster-io/dagster/tree/master/helm/dagster
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dagster
spec:
  interval: 15m
  chart:
    spec:
      chart: dagster
      version: "1.12.15"
      sourceRef:
        kind: HelmRepository
        name: dagster
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    # Pull secret for private GHCR images (e.g. hempriser pipeline)
    imagePullSecrets:
      - name: ghcr-pull
    # Crunchy Postgres: PgBouncer in database namespace; secret dagster-postgresql-secret (ExternalSecret → crunchy-pgo-secrets)
    postgresql:
      enabled: false
      postgresqlHost: postgres-pgbouncer.database.svc.cluster.local
      image:
        repository: docker.io/library/postgres
        tag: "18.2"
        pullPolicy: IfNotPresent
      postgresqlParams: {}
      service:
        port: 5432
    generatePostgresqlPasswordSecret: false
    # Skip DB-ready init container (uses postgres image → ImagePullBackOff); we use Crunchy external DB
    dagsterWebserver:
      checkDbReadyInitContainer: false
      workspace:
        enabled: true
        servers:
          - host: hempriser-pipeline.development.svc.cluster.local
            port: 4000
            name: hempriser-pipeline
          - host: bandit-pipeline.development.svc.cluster.local
            port: 4000
            name: bandit-pipeline
    dagsterDaemon:
      checkDbReadyInitContainer: false
    runLauncher:
      type: K8sRunLauncher
      config:
        k8sRunLauncher:
          jobNamespace: datasci
          envVars:
            - "DAGSTER_HOME=/tmp/dagster"
            - "RAY_ADDRESS=ray://ray-kuberay-head-svc.datasci.svc.cluster.local:10001"
            - "BANDIT_SERVICE_URL=http://bandit-service.development.svc.cluster.local:8000"
            - "MLFLOW_TRACKING_URI=http://mlflow.datasci.svc.cluster.local:5000"
          envSecrets:
            - name: hempriser-minio
            - name: hempriser-postgres
            - name: bandit-minio
            - name: bandit-postgres
          resources:
            requests:
              cpu: 2000m
              memory: 4Gi
            limits:
              cpu: 4000m
              memory: 16Gi
    # User code: subchart disabled (no pods). Workspace still created via dagsterWebserver.workspace above.
    dagster-user-deployments:
      enabled: true
      enableSubchart: false
    # Expose webserver at dagster.${SECRET_DOMAIN} (like mlflow / prefect)
    ingress:
      enabled: true
      ingressClassName: internal
      labels: {}
      annotations:
        nginx.ingress.kubernetes.io/whitelist-source-range: |
          10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
      dagsterWebserver:
        host: dagster.${SECRET_DOMAIN}
        path: /
        pathType: Prefix
        tls:
          enabled: true
          secretName: ""
        precedingPaths: []
        succeedingPaths: []
      readOnlyDagsterWebserver:
        host: dagster-ro.${SECRET_DOMAIN}
        path: /
        pathType: Prefix
        tls:
          enabled: true
          secretName: ""
        precedingPaths: []
        succeedingPaths: []
      flower:
        host: dagster-flower.${SECRET_DOMAIN}
        path: /
        pathType: Prefix
        tls:
          enabled: true
          secretName: ""
        precedingPaths: []
        succeedingPaths: []
  valuesFrom:
    - kind: Secret
      name: dagster-postgresql-secret
      valuesKey: postgresql-username
      targetPath: postgresql.postgresqlUsername
    - kind: Secret
      name: dagster-postgresql-secret
      valuesKey: postgresql-password
      targetPath: postgresql.postgresqlPassword
    - kind: Secret
      name: dagster-postgresql-secret
      valuesKey: postgresql-database
      targetPath: postgresql.postgresqlDatabase
