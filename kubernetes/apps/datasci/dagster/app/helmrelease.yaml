---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
# https://artifacthub.io/packages/helm/dagster/dagster
# https://github.com/dagster-io/dagster/tree/master/helm/dagster
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dagster
spec:
  interval: 15m
  chart:
    spec:
      chart: dagster
      version: "1.12.14"
      sourceRef:
        kind: HelmRepository
        name: dagster
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    # Crunchy Postgres: PgBouncer in database namespace; secret dagster-postgresql-secret (ExternalSecret â†’ crunchy-pgo-secrets)
    postgresql:
      enabled: false
      postgresqlHost: postgres-pgbouncer.database.svc.cluster.local
      image:
        repository: docker.io/library/postgres
        tag: "14.6"
        pullPolicy: IfNotPresent
      postgresqlParams: {}
      service:
        port: 5432
    generatePostgresqlPasswordSecret: false
    # Skip DB-ready init container to avoid ImagePullBackOff on docker.io/library/postgres (external DB already known reachable)
    dagsterWebserver:
      checkDbReadyInitContainer: false
    daemon:
      checkDbReadyInitContainer: false
    # User code deployment (must match dagsterWebserver.workspace.servers host name).
    dagster-user-deployments:
      enabled: true
      enableSubchart: true
      deployments:
        - name: k8s-example-user-code-1
          image:
            repository: docker.io/dagster/user-code-example
            tag: "1.12.14"
            pullPolicy: Always
          dagsterApiGrpcArgs:
            - "--python-file"
            - "/example_project/example_repo/repo.py"
          port: 3030
    # Expose webserver at dagster.${SECRET_DOMAIN} (like mlflow / prefect)
    ingress:
      enabled: true
      ingressClassName: internal
      labels: {}
      annotations:
        nginx.ingress.kubernetes.io/whitelist-source-range: |
          10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
      dagsterWebserver:
        host: dagster.${SECRET_DOMAIN}
        path: /
        pathType: Prefix
        tls:
          enabled: true
          secretName: ""
        precedingPaths: []
        succeedingPaths: []
      readOnlyDagsterWebserver:
        host: dagster-ro.${SECRET_DOMAIN}
        path: /
        pathType: Prefix
        tls:
          enabled: true
          secretName: ""
        precedingPaths: []
        succeedingPaths: []
      flower:
        host: dagster-flower.${SECRET_DOMAIN}
        path: /
        pathType: Prefix
        tls:
          enabled: true
          secretName: ""
        precedingPaths: []
        succeedingPaths: []
  valuesFrom:
    - kind: Secret
      name: dagster-postgresql-secret
      valuesKey: postgresql-username
      targetPath: postgresql.postgresqlUsername
    - kind: Secret
      name: dagster-postgresql-secret
      valuesKey: postgresql-password
      targetPath: postgresql.postgresqlPassword
    - kind: Secret
      name: dagster-postgresql-secret
      valuesKey: postgresql-database
      targetPath: postgresql.postgresqlDatabase
