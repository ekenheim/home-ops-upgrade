---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: deploykf-app-of-apps
  namespace: argocd
  labels:
    app.kubernetes.io/name: deploykf-app-of-apps
    app.kubernetes.io/part-of: deploykf
spec:
  project: "default"

  source:
    ## Use the deployKF repo to get sample-values.yaml as base
    ## This makes upgrades easier - just change targetRevision and source_version
    repoURL: "https://github.com/deployKF/deployKF.git"
    targetRevision: "v0.1.5"
    path: "."

    ## Plugin configuration
    plugin:
      name: "deploykf"
      parameters:
        ## deployKF generator version
        - name: "source_version"
          string: "0.1.5"

        ## Use sample-values.yaml as base
        - name: "values_files"
          array:
            - "./sample-values.yaml"

        ## Your custom overrides (merged on top of sample-values.yaml)
        - name: "values"
          string: |
            ##
            ## Custom overrides for home-ops-upgrade cluster
            ##

            ## --------------------------------------------------------------------------------
            ##                                      argocd
            ## --------------------------------------------------------------------------------
            argocd:
              namespace: argocd
              project: default
              source:
                repo:
                  url: "https://github.com/ekenheim/home-ops-upgrade.git"
                  revision: "main"
                  path: "./kubernetes/apps/datasci/deploykf-values/"

            ## --------------------------------------------------------------------------------
            ##                                    kubernetes
            ## --------------------------------------------------------------------------------
            ## Override kubectl image globally
            ## NOTE: `registry.k8s.io/kubectl` is too minimal for deployKF's "generate secrets" jobs
            ##       (it lacks a shell needed to run `/job-scripts/*.sh`), so we use Bitnami's image.
            kubernetes:
              kubectlImage:
                repository: docker.io/bitnami/kubectl
                tag: "latest"

            ## --------------------------------------------------------------------------------
            ##                              deploykf-dependencies
            ## --------------------------------------------------------------------------------
            deploykf_dependencies:
              ## Reuse existing cert-manager
              cert_manager:
                enabled: false
                namespace: cert-manager
                clusterIssuer:
                  enabled: false
                  issuerName: "selfsigned-deploykf"

              ## Reuse existing Istio
              istio:
                enabled: false
                namespace: istio-system

              ## Deploy Kyverno (required by deployKF)
              ## NOTE: Kyverno v1.10.0 has bugs - these workarounds are needed:
              ##   - Single replica to avoid leader election race conditions
              ##   - Increased memory (1Gi) to prevent OOMKilled
              ##   - Disabled readiness probe (returns HTTP 500 due to bugs)
              ##   - Disabled cleanup jobs (use non-existent kubectl image)
              ##
              ## If Kyverno fails with TLS errors, manually create this Certificate:
              ##   kubectl apply -f - <<EOF
              ##   apiVersion: cert-manager.io/v1
              ##   kind: Certificate
              ##   metadata:
              ##     name: kyverno-svc-tls
              ##     namespace: kyverno
              ##   spec:
              ##     secretName: kyverno-svc.kyverno.svc.kyverno-tls-pair
              ##     issuerRef: {name: selfsigned-deploykf, kind: ClusterIssuer}
              ##     dnsNames: [kyverno-svc, kyverno-svc.kyverno, kyverno-svc.kyverno.svc, kyverno-svc.kyverno.svc.cluster.local]
              ##   EOF
              kyverno:
                enabled: true
                namespace: kyverno
                values:
                  admissionController:
                    replicas: 1
                    resources:
                      limits:
                        memory: 1Gi
                      requests:
                        memory: 256Mi
                    ## Disable readiness probe - v1.10.0 has a bug where it returns HTTP 500
                    readinessProbe: null
                  backgroundController:
                    resources:
                      limits:
                        memory: 1Gi
                      requests:
                        memory: 256Mi
                  cleanupJobs:
                    admissionReports:
                      enabled: false
                    clusterAdmissionReports:
                      enabled: false

            ## --------------------------------------------------------------------------------
            ##                                  deploykf-core
            ## --------------------------------------------------------------------------------
            deploykf_core:
              deploykf_auth:
                namespace: deploykf-auth
                ## Override kubectl image used by deploykf-auth jobs (needs a shell to run scripts)
                images:
                  kubectl:
                    repository: docker.io/bitnami/kubectl
                    tag: "latest"
                dex:
                  staticPasswords:
                    # NOTE: deployKF's default Profiles/RBAC examples assume these users exist.
                    # If you remove them, you must also update deploykf_profiles_generator users/groups/profiles accordingly.
                    - email: "admin@admin.com"
                      password:
                        value: "password"
                    - email: "user1@example.com"
                      password:
                        value: "user1"
                    - email: "user2@example.com"
                      password:
                        value: "user2"
                  connectors: []
                  clients:
                    oauth2Proxy:
                      clientId: "oauth2-proxy"
                      clientSecret:
                        existingSecret: "generated--dex-oauth2-proxy-client"
                        existingSecretKey: "client_secret"
                        generateSecret: true
                    minioConsole:
                      clientId: "minio-console"
                      clientSecret:
                        existingSecret: "generated--dex-minio-console-client"
                        existingSecretKey: "client_secret"
                        generateSecret: true
                    argoServer:
                      clientId: "argo-server"
                      clientSecret:
                        existingSecret: "generated--dex-argo-server-client"
                        existingSecretKey: "client_secret"
                        generateSecret: true
                oauth2Proxy:
                  cookie:
                    secret:
                      existingSecret: "generated--oauth2-proxy-cookie-secret"
                      existingSecretKey: "cookie_secret"
                      generateSecret: true

              deploykf_dashboard:
                namespace: deploykf-dashboard

              deploykf_istio_gateway:
                # Reuse existing Istio gateway deployment + Service (istio-system/cluster-gateway-istio)
                # See: https://www.deploykf.org/guides/dependencies/istio/
                namespace: istio-system
                charts:
                  # Disable deployKF's embedded gateway deployment/service (we are reusing an existing one)
                  istioGateway:
                    enabled: false
                gateway:
                  hostname: deploykf.istio.local
                  ports:
                    http: 80
                    https: 443
                  tls:
                    existingSecret: istio-gateway-local-certs
                  selectorLabels:
                    app: istio-ingress
                    istio: ingress
                gatewayDeployment:
                  serviceAccount:
                    name: istio-ingress
                    annotations: {}
                gatewayService:
                  ports:
                    http: 80
                    https: 443

              deploykf_profiles_generator:
                profileDefaults:
                  memberAccess:
                    role: view
                    notebooksAccess: false
                  plugins: []
                  resourceQuotaSpec: {}
                  tools:
                    kubeflowPipelines:
                      objectStoreAuth:
                        existingSecret: "kubeflow-pipelines--profile-object-store-auth--{profile_name}"
                        existingSecretNamespace: ""
                        existingSecretAccessKeyKey: "access_key"
                        existingSecretSecretKeyKey: "secret_key"
                # Explicit profile/user mapping so RBAC is deterministic.
                # IMPORTANT: user emails MUST exactly match the email claim from Dex (or your IdP).
                users:
                  - id: admin
                    email: "admin@admin.com"
                  - id: user-1
                    email: "user1@example.com"
                  - id: user-2
                    email: "user2@example.com"
                groups:
                  - id: team-1
                    users: ["admin", "user-1", "user-2"]
                profiles:
                  - name: team-1
                    members:
                      - group: team-1
                        access:
                          role: edit
                          notebooksAccess: true
                  - name: team-1-prod
                    members:
                      - group: team-1
                        access:
                          role: view
                          notebooksAccess: false

            ## --------------------------------------------------------------------------------
            ##                                   deploykf-opt
            ## --------------------------------------------------------------------------------
            deploykf_opt:
              ## Disable embedded MinIO - use external
              deploykf_minio:
                enabled: false
                namespace: deploykf-minio

              ## Enable embedded MySQL
              deploykf_mysql:
                enabled: true
                namespace: deploykf-mysql
                ## Override kubectl image used by deploykf-mysql "generate secrets" jobs
                ## (deployKF 0.1.5 references old Bitnami kubectl tags that were removed)
                images:
                  kubectl:
                    repository: docker.io/bitnami/kubectl
                    tag: "latest"
                rootUser:
                  existingSecret: "generated--deploykf-mysql-root-user"
                  existingSecretPasswordKey: "password"
                  generateSecret: true
                kubeflowUser:
                  existingSecret: "generated--deploykf-mysql-kubeflow-user"
                  existingSecretUsernameKey: "username"
                  existingSecretPasswordKey: "password"
                  generateSecret: true

            ## --------------------------------------------------------------------------------
            ##                              kubeflow-dependencies
            ## --------------------------------------------------------------------------------
            kubeflow_dependencies:
              kubeflow_argo_workflows:
                enabled: true
                namespace: kubeflow-argo-workflows

            ## --------------------------------------------------------------------------------
            ##                                  kubeflow-tools
            ## --------------------------------------------------------------------------------
            kubeflow_tools:
              katib:
                enabled: true
                mysql:
                  useExternal: false
                mysqlDatabase: katib

              notebooks:
                enabled: true
                spawnerFormDefaults: {}

              pipelines:
                enabled: true
                bucket:
                  name: kubeflow-pipelines
                  region: ""
                objectStore:
                  useExternal: true
                  host: minio-secondary.storage.svc.cluster.local
                  port: 443
                  useSSL: true
                  auth:
                    fromEnv: false
                    accessKey: ""
                    secretKey: ""
                    existingSecret: "mlflow-minio-creds"
                    existingSecretAccessKeyKey: "AWS_ACCESS_KEY_ID"
                    existingSecretSecretKeyKey: "AWS_SECRET_ACCESS_KEY"
                mysql:
                  useExternal: false
                mysqlDatabases:
                  cacheDatabase: kfp_cache
                  metadataDatabase: kfp_metadata
                  pipelinesDatabase: kfp_pipelines
                profileResourceGeneration:
                  kfpApiTokenPodDefault: false

              poddefaults_webhook:
                enabled: true

              tensorboards:
                enabled: true

              training_operator:
                enabled: true

              volumes:
                enabled: true

  destination:
    server: "https://kubernetes.default.svc"

  syncPolicy:
    ## Start with manual sync - enable automated once stable
    automated:
      prune: false
      selfHeal: false
