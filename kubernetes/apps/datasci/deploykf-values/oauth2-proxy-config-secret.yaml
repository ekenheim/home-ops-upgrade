---
## Persistent override for deployKF oauth2-proxy config.
## Reason: deployKF uses a self-signed gateway certificate by default (deploykf.istio.local),
## which causes oauth2-proxy OIDC discovery to fail with:
##   x509: certificate signed by unknown authority
##
## This sets `ssl_insecure_skip_verify = true` to allow oauth2-proxy to talk to Dex via the gateway.
## (Best long-term fix is to use a real domain + publicly trusted cert.)
apiVersion: v1
kind: Secret
metadata:
  name: oauth2-proxy-config
  namespace: deploykf-auth
type: Opaque
stringData:
  oauth2-proxy.cfg: |
    ## tcp address to listen on
    http_address = "0.0.0.0:4180"
    
    ## serve a static HTTP 200 upstream on for authentication success
    ## (this is because we are using oauth2-proxy as an ExtAuthz to "check" each request, not pass it on)
    upstreams = [
      "static://200"
    ]
    
    ## requests to paths matching these regex patterns will receive a 401 Unauthorized response
    ## when not authenticated, instead of being redirected to the login page with a 302
    ## (prevents background requests being redirected to the login page, and the accumulation of CSRF cookies)
    api_routes = [
      ## Generic
      ## NOTE: included because most background requests contain these paths
      "/api/",
      "/apis/",
    
      ## Kubeflow Pipelines
      ## NOTE: included because KFP UI makes MANY background requests to these paths but because they are
      ##       not `application/json` requests, oauth2-proxy will redirect them to the login page
      "^/ml_metadata",
    ]
    
    ################
    ## branding
    ################
    custom_sign_in_logo = "/custom-theme/logo.svg"
    banner = "-"
    footer = "-"
    
    ################
    ## proxy
    ################
    reverse_proxy = true
    real_client_ip_header = "X-Forwarded-For"
    
    ################
    ## logging
    ################
    logging_filename = ""
    logging_max_size = 100
    logging_max_age = 7
    standard_logging = true
    request_logging = true
    auth_logging = true
    
    ################
    ## upstream headers (to dex)
    ################
    ## pass headers: `Authorization`
    pass_authorization_header = false
    
    ## pass headers: HTTP Basic Auth, `X-Forwarded-User`, `X-Forwarded-Email`
    pass_basic_auth = false
    
    ## pass headers: `X-Forwarded-User`, `X-Forwarded-Groups`, `X-Forwarded-Email`, `X-Forwarded-Preferred-Username`
    pass_user_headers = false
    
    ## pass headers: `Host`
    pass_host_header = true
    
    ################
    ## response headers (to EnvoyFilter)
    ################
    ## set headers: `Authorization`
    set_authorization_header = true
    
    ## set headers: `X-Auth-Request-User`, `X-Auth-Request-Groups`, `X-Auth-Request-Email`, `X-Auth-Request-Preferred-Username`
    set_xauthrequest = true
    
    ################
    ## provider
    ################
    provider = "oidc"
    provider_display_name = "Dex"
    
    client_id = "oauth2-proxy"
    
    oidc_email_claim = "email"
    oidc_groups_claim = "groups"
    
    ## specify the list of scopes to request
    ## NOTE: offline_access enables refresh tokens (but not all dex connectors support it, notably SAML 2.0)
    ##       https://dexidp.io/docs/custom-scopes-claims-clients/
    ##       https://dexidp.io/docs/connectors/
    scope = "openid email groups profile offline_access"
    
    oidc_issuer_url = "https://deploykf.istio.local/dex"
    
    ## WORKAROUND:
    ## - oauth2-proxy runs inside the cluster and may not be able to hairpin to the external gateway VIP
    ## - avoid OIDC discovery calls to `https://deploykf.istio.local/...` which can hang/timeout
    ## - instead, use explicit OIDC endpoints for server-to-server calls via the in-cluster Dex Service (HTTP)
    skip_oidc_discovery = true
    login_url = "https://deploykf.istio.local/dex/auth"
    redeem_url = "http://dex.deploykf-auth.svc.cluster.local:5556/dex/token"
    oidc_jwks_url = "http://dex.deploykf-auth.svc.cluster.local:5556/dex/keys"
    profile_url = "http://dex.deploykf-auth.svc.cluster.local:5556/dex/userinfo"
    
    ## gateway uses a self-signed cert, so skip TLS verification when oauth2-proxy talks to public HTTPS endpoints
    ssl_insecure_skip_verify = true
    
    redirect_url = "https://deploykf.istio.local/oauth2/callback"
    
    email_domains = ["*"]
    
    ## if false, a sign-in page is shown before redirecting to dex
    skip_provider_button = true
    
    ## oauth2-proxy sends "force" by default, which causes dex to always prompt for login
    ## https://github.com/dexidp/dex/pull/3086
    prompt = "none"
    
    ## oauth2-proxy does not verify nonce claim by default
    insecure_oidc_skip_nonce = false
    
    ## use PKCE code challenges
    code_challenge_method = "S256"
    
    ################
    ## bearer token
    ################
    
    ## allow bearer tokens to be used for authentication
    skip_jwt_bearer_tokens = true
    
    ## trust audience claims used by other known dex clients
    oidc_extra_audiences = [
      "kubeflow-pipelines-sdk"
    ]
    
    ################
    ## cookie
    ################
    cookie_name = "__Secure-_deploykf_token"
    cookie_path = "/"
    cookie_domains = []
    cookie_expire = "168h"
    cookie_refresh = "60m"
    cookie_secure = true
    cookie_httponly = true
    cookie_samesite = "lax"
    cookie_csrf_expire = "15m"
    cookie_csrf_per_request = true

