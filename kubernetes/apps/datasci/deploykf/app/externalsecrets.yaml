---
apiVersion: v1
kind: Namespace
metadata:
  name: deploykf-auth
---
apiVersion: v1
kind: Namespace
metadata:
  name: kubeflow
---
# OIDC client for deployKF (Dex) from Bitwarden
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: deploykf-oidc
  namespace: deploykf-auth
spec:
  secretStoreRef:
    name: bitwarden-secrets-manager
    kind: ClusterSecretStore
  refreshInterval: 15m
  target:
    name: deploykf-oidc
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      engineVersion: v2
      data:
        config: |
          issuer: "{{ .ISSUER }}"
          clientID: "{{ .CLIENT_ID }}"
          clientSecret: "{{ .CLIENT_SECRET }}"
          redirectURI: "https://kf.kubeflow.com/dex/callback"
          scopes:
            - openid
            - profile
            - email
          insecureSkipEmailVerified: false
          insecureEnableGroups: true
          claimMapping:
            email: email
            groups: groups
  dataFrom:
    - extract:
        key: deploykf-oidc
---
# MinIO credentials for deployKF artifact store (reuse existing Bitwarden item)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: deploykf-minio-creds
  namespace: kubeflow
spec:
  secretStoreRef:
    name: bitwarden-secrets-manager
    kind: ClusterSecretStore
  refreshInterval: 15m
  target:
    name: deploykf-minio-creds
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      engineVersion: v2
      data:
        AWS_ACCESS_KEY_ID: "{{ .AWS_ACCESS_KEY_ID }}"
        AWS_SECRET_ACCESS_KEY: "{{ .AWS_SECRET_ACCESS_KEY }}"
  dataFrom:
    - extract:
        key: minio-secondary-creds

