# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &name flyte-secret
spec:
  secretStoreRef:
    name: bitwarden-secrets-manager
    kind: ClusterSecretStore
  refreshInterval: 15m
  target:
    name: *name
    template:
      data:
        values.yaml: |
          fullnameOverride: "flyte"
          commonAnnotations:
            reloader.stakater.com/auto: "true"
          configuration:
            storage:
              metadataContainer: flyte-metadata
              userDataContainer: flyte-user-data
              provider: s3
              providerConfig:
                s3:
                  authType: "accesskey"
                  endpoint: http://minio.storage.svc.cluster.local:9000
                  accessKey: "{{ .FLYTE_MINIO_ACCESS_KEY }}"
                  secretKey: "{{ .FLYTE_MINIO_SECRET_KEY }}"
            tasks:
              task-plugins:
                enabled-plugins:
                  - container
                  - sidecar
                  - K8S-ARRAY
                  - agent-service
                  - echo
                default-for-task-types:
                  - container: container
          clusterResourceTemplates:
            inline:
              001_namespace.yaml: |
                apiVersion: v1
                kind: Namespace
                metadata:
                  name: '\{\{ namespace \}\}'
              002_serviceaccount.yaml: |
                apiVersion: v1
                kind: ServiceAccount
                metadata:
                  name: default
                  namespace: '\{\{ namespace \}\}'
          ingress:
            create: true
            ingressClassName: internal
            host: flyte.${SECRET_DOMAIN}
            annotations:
              nginx.ingress.kubernetes.io/whitelist-source-range: |
                10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
              nginx.ingress.kubernetes.io/app-root: /console
              nginx.ingress.kubernetes.io/backend-protocol: GRPC
          serviceAccount:
            create: true
  dataFrom:
    - extract:
        key: minio
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &name flyte-db-secret
spec:
  refreshInterval: 1m
  secretStoreRef:
    name: crunchy-pgo-secrets
    kind: ClusterSecretStore
  target:
    name: *name
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      engineVersion: v2
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/managed-by: Helm
        annotations:
          meta.helm.sh/release-name: flyte
          meta.helm.sh/release-namespace: datasci
      data:
        DB_TYPE: postgres
        DB_HOST: '{{ index . "pgbouncer-host" }}'
        DB_PORT: "5432"
        DB_NAME: '{{ .dbname }}'
        DB_USER: '{{ .user }}'
        DB_PASSWORD: '{{ .password }}'
        DB_CONNECTION_STRING: 'postgresql+psycopg2://{{ .user }}:{{ .password }}@{{ index . "pgbouncer-host" }}:5432/{{ .dbname }}'
        values.yaml: |
          configuration:
            database:
              type: postgres
              host: postgres-primary.database.svc.cluster.local
              port: 5432
              dbname: flyte
              username: flyte
              password: {{ .password }}
              connection-string: postgresql+psycopg2://flyte:{{ .password }}@postgres-primary.database.svc.cluster.local:5432/flyte
              options:
                sslmode: disable
  dataFrom:
    - extract:
        key: postgres-pguser-flyte
