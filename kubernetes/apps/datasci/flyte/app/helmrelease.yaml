apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flyte
  namespace: datasci
spec:
  interval: 30m
  chart:
    spec:
      chart: flyte-binary
      version: v1.15.3
      sourceRef:
        kind: HelmRepository
        name: flyteorg
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    ingress:
      create: false # Disable ingress creation by the chart
    # Configuration specific to the flyte-binary chart - Ingress removed as it will be managed manually
    # ingress:
    #   create: true
    #   ingressClassName: internal
    #   host: "flyte.${SECRET_DOMAIN}"
    #   annotations:
    #     nginx.ingress.kubernetes.io/app-root: "/console"
    #   httpAnnotations:
    #     kubernetes.io/ingress.class: "internal"
    #

    #   separateGrpcIngress: true
    #   grpcHost: "flyte-api.${SECRET_DOMAIN}"
    #   grpcIngressClassName: external
    #   grpcAnnotations:
    #     kubernetes.io/ingress.class: "external"
    #     external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
    #     nginx.ingress.kubernetes.io/backend-protocol: "GRPC" # Important for gRPC
    #

    #   # Explicit TLS sections instead of combined
    #   httpTls: # Specific TLS for HTTP ingress
    #     - hosts:
    #         - "flyte.${SECRET_DOMAIN}"
    #       secretName: flyte-tls
    #   grpcTls: # Specific TLS for gRPC ingress
    #    - hosts:
    #        - "flyte-api.${SECRET_DOMAIN}"
    #      secretName: flyte-api-tls # Use a potentially different secret if needed

  valuesFrom:
    - kind: Secret
      name: flyte-secret
      valuesKey: values.yaml
      optional: true
    - kind: Secret
      name: flyte-db-secret
      valuesKey: values.yaml
