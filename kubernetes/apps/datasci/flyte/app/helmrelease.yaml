apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flyte
  namespace: datasci
spec:
  interval: 30m
  chart:
    spec:
      chart: flyte-binary
      version: v1.15.3
      sourceRef:
        kind: HelmRepository
        name: flyteorg
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    # Configuration specific to the flyte-binary chart
    ingress:
      create: true # Enable ingress creation by the chart
      ingressClassName: internal # Default class for console/http
      host: "flyte.${SECRET_DOMAIN}" # Console hostname
      annotations:
        # Add any common annotations here if needed
        # e.g., nginx specific settings common to both
        nginx.ingress.kubernetes.io/app-root: "/console" # From original ExternalSecret
      httpAnnotations: # Annotations specific to the HTTP ingress (console)
        # We'll set the class explicitly here for the console
        kubernetes.io/ingress.class: "internal"
        # Add other internal-specific annotations if required

      separateGrpcIngress: true # We want a separate ingress for API/gRPC
      grpcHost: "flyte-api.${SECRET_DOMAIN}" # API hostname
      grpcIngressClassName: external # Class for gRPC/api
      grpcAnnotations:
        # Annotations specific to the gRPC ingress (API)
        kubernetes.io/ingress.class: "external"
        external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
        nginx.ingress.kubernetes.io/backend-protocol: "GRPC" # Important for gRPC
        # Add other external-specific annotations if required

      # Common TLS config (can be overridden by httpTls/grpcTls if needed)
      tls:
        - hosts:
            - "flyte.${SECRET_DOMAIN}"
          secretName: flyte-tls # Assuming a secret named flyte-tls exists or is managed elsewhere
        - hosts:
            - "flyte-api.${SECRET_DOMAIN}"
          secretName: flyte-api-tls # Assuming a secret named flyte-api-tls exists or is managed elsewhere

  valuesFrom:
    - kind: Secret
      name: flyte-secret
      valuesKey: values.yaml
      optional: true
    - kind: Secret
      name: flyte-db-secret
      valuesKey: values.yaml
