# Add initContainer to create KFP/MLMD DBs (metadb, mlpipeline, cachedb) before the
# metadata store server starts. Upstream MySQL does not create them; without this,
# metadata-grpc fails and metadata-writer/ml-pipeline cannot connect.
# Idempotent: CREATE DATABASE IF NOT EXISTS. Pod restarts until MySQL is ready.
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: metadata-grpc-deployment
spec:
  template:
    spec:
      initContainers:
        - name: create-mysql-dbs
          image: mysql:9.6
          command:
            - /bin/sh
            - -ec
            - |
              for i in $(seq 1 90); do
                if mysql -h "${MYSQL_HOST}" -P "${MYSQL_PORT}" -u "${DBCONFIG_USER}" \
                  --password="${DBCONFIG_PASSWORD}" --connect-timeout=5 -e "SELECT 1" 2>/dev/null; then
                  break
                fi
                echo "Waiting for MySQL (attempt $i/90)..."
                sleep 2
              done
              if ! mysql -h "${MYSQL_HOST}" -P "${MYSQL_PORT}" -u "${DBCONFIG_USER}" \
                --password="${DBCONFIG_PASSWORD}" --connect-timeout=5 -e "SELECT 1" 2>/dev/null; then
                echo "FATAL: MySQL never became ready"
                exit 1
              fi
              mysql -h "${MYSQL_HOST}" -P "${MYSQL_PORT}" -u "${DBCONFIG_USER}" \
                --password="${DBCONFIG_PASSWORD}" --connect-timeout=5 -e "
                CREATE DATABASE IF NOT EXISTS ${MYSQL_MLMD_DB};
                CREATE DATABASE IF NOT EXISTS ${MYSQL_PIPELINE_DB};
                CREATE DATABASE IF NOT EXISTS ${MYSQL_CACHE_DB};
              "
          env:
            - name: DBCONFIG_USER
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: username
            - name: DBCONFIG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: password
            - name: MYSQL_HOST
              valueFrom:
                configMapKeyRef:
                  name: pipeline-install-config
                  key: dbHost
            - name: MYSQL_PORT
              valueFrom:
                configMapKeyRef:
                  name: pipeline-install-config
                  key: dbPort
            - name: MYSQL_MLMD_DB
              valueFrom:
                configMapKeyRef:
                  name: pipeline-install-config
                  key: mlmdDb
            - name: MYSQL_PIPELINE_DB
              valueFrom:
                configMapKeyRef:
                  name: pipeline-install-config
                  key: pipelineDb
            - name: MYSQL_CACHE_DB
              valueFrom:
                configMapKeyRef:
                  name: pipeline-install-config
                  key: cacheDb
