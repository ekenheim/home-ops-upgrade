apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # Local resources
  - namespace.yaml
  - authz-policies.yaml
  # Dex - OAuth2 Proxy overlay
  - https://github.com/kubeflow/manifests/common/dex/overlays/oauth2-proxy?ref=v1.11.0
  # OAuth2 Proxy - m2m-dex-only overlay (works on most clusters)
  - https://github.com/kubeflow/manifests/common/oauth2-proxy/overlays/m2m-dex-only?ref=v1.11.0
  # Knative Serving (for KServe)
  - https://github.com/kubeflow/manifests/common/knative/knative-serving/overlays/gateways?ref=v1.11.0
  - https://github.com/kubeflow/manifests/common/istio/cluster-local-gateway/base?ref=v1.11.0
  # Network policies
  - https://github.com/kubeflow/manifests/common/networkpolicies/base?ref=v1.11.0
  # Kubeflow roles
  - https://github.com/kubeflow/manifests/common/kubeflow-roles/base?ref=v1.11.0
  # Kubeflow Istio resources (Gateway, VirtualServices)
  - https://github.com/kubeflow/manifests/common/istio/kubeflow-istio-resources/base?ref=v1.11.0

patches:
  # Patch kubeflow namespace to merge all labels
  - path: patches/namespace.yaml
    target:
      kind: Namespace
      name: kubeflow
  # Patch knative-serving namespace for pod security
  - path: patches/knative-namespace.yaml
    target:
      kind: Namespace
      name: knative-serving
  # Patch auth namespace for pod security
  - path: patches/auth-namespace.yaml
    target:
      kind: Namespace
      name: auth
  # Patch Dex ConfigMap for issuer URL and static users
  - path: patches/dex-config.yaml
    target:
      kind: ConfigMap
      name: dex
      namespace: auth
  # Patch OAuth2 Proxy for kubeflow.istio.local hostname
  - path: patches/oauth2-proxy-env.yaml
    target:
      kind: Deployment
      name: oauth2-proxy
      namespace: oauth2-proxy
  # Patch kubeflow-gateway to use existing Istio ingress
  - path: patches/kubeflow-gateway.yaml
    target:
      kind: Gateway
      name: kubeflow-gateway
      namespace: kubeflow
  # Patch trainer-webhook NetworkPolicy to match when Istio sidecar is disabled
  - path: patches/trainer-webhook-networkpolicy.yaml
    target:
      kind: NetworkPolicy
      name: trainer-webhook
  # Patch ml-pipeline NetworkPolicy to allow in-namespace KFP components (persistenceagent, scheduledworkflow, etc.)
  - path: patches/ml-pipeline-networkpolicy.yaml
    target:
      kind: NetworkPolicy
      name: ml-pipeline
      namespace: kubeflow
  # Patch metadata-grpc-server NetworkPolicy to explicitly allow same-namespace (kubeflow) ingress
  - path: patches/metadata-grpc-server-networkpolicy.yaml
    target:
      kind: NetworkPolicy
      name: metadata-grpc-server
      namespace: kubeflow
