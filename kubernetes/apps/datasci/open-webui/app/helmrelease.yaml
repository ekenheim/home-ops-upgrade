---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app open-webui
spec:
  interval: 5m
  chart:
    spec:
      chart: app-template
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controller:
      enabled: true
      name: open-webui
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      app:
        image:
          repository: ghcr.io/open-webui/open-webui
          tag: 0.6.13@sha256:ddc64d14ec933e8c1caf017df8a0068bece3e35acbc59e4aa4971e5aa4176a72
        env:
          OLLAMA_BASE_URL: http://ollama:11434
          ENABLE_RAG_WEB_SEARCH: true
          ENABLE_SEARCH_QUERY: true
          RAG_WEB_SEARCH_ENGINE: searxng
          SEARXNG_QUERY_URL: http://searxng:8080/search?q=<query>
          ENABLE_WEBSOCKET_SUPPORT: "true"
          WEBSOCKET_MANAGER: "redis"
          WEBSOCKET_REDIS_URL: redis://open-webui-dragonfly:6379
          DATABASE_URL:
            valueFrom:
              secretKeyRef:
                name: open-webui-pguser-open-webui
                key: pgbouncer-uri
        envFrom:
          - secretRef:
              name: *app
        resources:
          requests:
            cpu: 500m
          limits:
            memory: 2Gi
    service:
      app:
        controller: open-webui
        ports:
          http:
            port: &port 8080
    ingress:
      app:
        className: internal
        annotations:
          nginx.ingress.kubernetes.io/whitelist-source-range: |
            10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
          tailscale.com/tags: "tag:k8s"
          tailscale.com/hostname: "chat.${SECRET_DOMAIN}"
        hosts:
          - host: &host chat.${SECRET_DOMAIN}
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: app
                  port: http
    persistence:
      config:
        enabled: true
        existingClaim: *app
        globalMounts:
          - path: /app/backend/data
