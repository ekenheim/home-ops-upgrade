apiVersion: v1
kind: ConfigMap
metadata:
  name: prefect-server-startup-script
  namespace: datasci
data:
  startup.py: |
    import os
    from sqlalchemy.engine.url import make_url

    original_url = os.environ.get('PREFECT_API_DATABASE_CONNECTION_URL')

    if original_url:
        url = make_url(original_url)
        if 'jit' in url.query:
            del url.query['jit']
        os.environ['PREFECT_API_DATABASE_CONNECTION_URL'] = str(url)

    from prefect.server import start
    start()
