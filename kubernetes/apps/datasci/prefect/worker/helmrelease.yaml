---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: prefect-worker
  namespace: datasci
spec:
  interval: 15m
  chart:
    spec:
      chart: prefect-worker
      version: 2024.8.15182057
      sourceRef:
        kind: HelmRepository
        name: prefect
        namespace: flux-system
  values:
    worker:
      image:
        repository: prefecthq/prefect
        prefectTag: 2-python3.11-kubernetes
      env:
        - name: PREFECT_API_URL
          value: "http://prefect-server.datasci.svc.cluster.local:4200/api"
        - name: PREFECT_KUBERNETES_NAMESPACE
          value: "datasci"
        - name: PREFECT_KUBERNETES_JOB_NAMESPACE
          value: "datasci"
      config:
        workPool: default
        namespace: datasci
        jobNamespace: datasci

    rbac:
      create: true
      rules:
        - apiGroups: ["batch"]
          resources: ["jobs"]
          verbs: ["create", "get", "list", "watch", "update", "patch", "delete"]
          namespaces: ["datasci"]
        - apiGroups: [""]
          resources: ["pods", "pods/log", "services"]
          verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
        - apiGroups: [""]
          resources: ["namespaces"]
          verbs: ["get", "list", "watch"]

    serviceAccount:
      create: true
      name: prefect-worker

    resources:
      limits:
        memory: 1Gi
      requests:
        cpu: 100m
        memory: 256Mi

    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
