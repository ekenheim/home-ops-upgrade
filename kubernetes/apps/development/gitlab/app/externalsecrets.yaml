---
# yaml-language-server: $schema=https://lds-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &bwname gitlab-bitwarden-secret
spec:
  secretStoreRef:
    name: bitwarden-secrets-manager # Use Bitwarden store
    kind: ClusterSecretStore
  refreshInterval: 15m
  target:
    name: *bwname
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # GitLab Core
        INITIAL_ROOT_PASSWORD: "{{ .GITLAB_ROOT_PASSWORD }}"
        # GitLab Runner
        runner-registration-token: "{{ .RUNNER_REGISTRATION_TOKEN }}"
        runner-token: "{{ .GITLAB_TOKEN_SECRET }}"
        # SMTP - Assuming these are also in the main gitlab bitwarden secret
        SMTP_PASSWORD: "{{ .GITLAB_SMTP_PASSWORD }}"
        SMTP_SERVER: "{{ .SMTP_SERVER }}"
        SMTP_USERNAME: "{{ .GITLAB_SMTP_USERNAME }}"
        SMTP_PORT: "{{ .SMTP_PORT }}"
  dataFrom:
    - extract:
        key: gitlab # Use 'gitlab' as the key in Bitwarden
---
# yaml-language-server: $schema=https://lds-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &dbname gitlab-db-secret
spec:
  secretStoreRef:
    name: crunchy-pgo-secrets # Use Crunchy Postgres store
    kind: ClusterSecretStore
  refreshInterval: 1m
  target:
    name: *dbname
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Map Crunchy keys to GitLab Helm chart keys
        GITLAB_DB_HOST: '{{ index . "pgbouncer-host" }}' # Use pgbouncer host from Crunchy secret
        # GITLAB_DB_PORT: '{{ index . "pgbouncer-port" }}' # Port is set directly in HelmRelease usually
        GITLAB_DB_NAME: '{{ .dbname }}'
        GITLAB_DB_USERNAME: '{{ .user }}'
        GITLAB_DB_PASSWORD: '{{ .password }}'
  dataFrom:
    - extract:
        key: postgres-pguser-gitlab # Assumed key for GitLab user in Crunchy secret
